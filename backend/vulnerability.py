from fastapi import FastAPI
from fastapi.responses import FileResponse
import os
from fastapi import APIRouter
router = APIRouter()

# vulnerability.pyfrom fastapi import APIRouter
from fastapi import APIRouter
from fastapi.responses import JSONResponse
import asyncio
import httpx
import platform
import requests
from typing import List, Dict, Any

router = APIRouter()

CVE_LIMIT_PER_PKG = 10  # Limit number of CVEs per package

# ---------------------------
# Utilities
# ---------------------------
def cvss_to_severity(score: float) -> str:
    if score >= 9.0:
        return "CRITICAL"
    elif score >= 7.0:
        return "HIGH"
    elif score >= 4.0:
        return "MEDIUM"
    elif score > 0:
        return "LOW"
    else:
        return "UNKNOWN"

# ---------------------------
# Python packages
# ---------------------------
from importlib.metadata import distributions

async def detect_pip_packages() -> List[Dict[str, str]]:
    pkgs = []
    for dist in distributions():
        pkgs.append({"name": dist.metadata["Name"], "version": dist.version})
    return pkgs

async def query_osv_for_package(client: httpx.AsyncClient, pkg: Dict[str, str]) -> List[Dict[str, Any]]:
    payload = {"package": {"name": pkg["name"], "ecosystem": "PyPI"}}
    try:
        resp = await client.post("https://api.osv.dev/v1/query", json=payload, timeout=15)
        data = resp.json()
        vulns = []

        for v in (data.get("vulns") or [])[:CVE_LIMIT_PER_PKG]:
            score_val = None
            severity = None

            # Try CVSS entries
            for cvss_item in v.get("cvss", []):
                base_score = cvss_item.get("baseScore")
                if base_score is not None:
                    score_val = float(base_score)
                    severity = cvss_to_severity(score_val)
                    break

            # Fallback to database-specific severity
            if severity is None:
                db_spec = v.get("database_specific", {})
                severity = db_spec.get("severity")
            
            # Default values if missing
            if score_val is None:
                score_val = "N/A"
            if severity is None:
                severity = "UNKNOWN"

            vulns.append({
                "package": pkg["name"],
                "version": pkg["version"],
                "cveId": v.get("id", "N/A"),
                "severity": severity,
                "score": score_val,
                "description": v.get("summary", "No description available")
            })

        return vulns

    except Exception as e:
        return [{
            "package": pkg["name"],
            "version": pkg["version"],
            "cveId": "ERROR",
            "severity": "ERROR",
            "score": "N/A",
            "description": str(e)
        }]

# ---------------------------
# Windows / System packages
# ---------------------------
def query_cve_nvd(keyword: str) -> List[Dict[str, Any]]:
    url = f"https://services.nvd.nist.gov/rest/json/cves/2.0?keyword={keyword}&resultsPerPage={CVE_LIMIT_PER_PKG}"
    try:
        r = requests.get(url, timeout=10)
        r.raise_for_status()
        data = r.json()
        vulns = []

        for item in data.get("vulnerabilities", []):
            cve_id = item["cve"]["id"]
            score_val = "N/A"
            severity = "UNKNOWN"

            # Attempt CVSS v3.1 metric
            metrics = item["cve"].get("metrics", {})
            if metrics:
                for metric_type in metrics:
                    cvss_list = metrics[metric_type].get("cvssMetricV31", [])
                    if cvss_list:
                        base_score = cvss_list[0].get("cvssData", {}).get("baseScore")
                        if base_score is not None:
                            score_val = round(float(base_score), 1)
                            severity = cvss_to_severity(score_val)
                            break

            description = item["cve"].get("descriptions", [{}])[0].get("value", "No description available")

            vulns.append({
                "package": keyword,
                "version": platform.version(),
                "cveId": cve_id,
                "severity": severity,
                "score": score_val,
                "description": description
            })

        return vulns

    except Exception as e:
        return [{
            "package": keyword,
            "version": platform.version(),
            "cveId": "ERROR",
            "severity": "ERROR",
            "score": "N/A",
            "description": str(e)
        }]

# ---------------------------
# Main API Endpoint
# ---------------------------

from fastapi import Query

@router.get("/api/vulnerabilities")
async def get_vulnerabilities(page: int = Query(1, ge=1), per_page: int = Query(20, ge=1, le=100)):
    """
    Returns paginated vulnerabilities for Python packages + system.
    page: current page number
    per_page: number of CVEs per page
    """

    # ---------------- Python packages ----------------
    packages = await detect_pip_packages()
    async with httpx.AsyncClient() as client:
        tasks = [query_osv_for_package(client, pkg) for pkg in packages]
        python_results = await asyncio.gather(*tasks)

    python_vulns = [item for sublist in python_results for item in sublist]

    # ---------------- System packages ----------------
    system_vulns = query_cve_nvd("Windows")

    # Merge results
    all_vulns = python_vulns + system_vulns

    # ---------------- Pagination ----------------
    total = len(all_vulns)
    start = (page - 1) * per_page
    end = start + per_page
    paginated_vulns = all_vulns[start:end]

    return JSONResponse({
        "vulns": paginated_vulns,
        "page": page,
        "per_page": per_page,
        "total": total,
        "total_pages": (total + per_page - 1) // per_page
    })



    
@router.get("/api/vulnerabilities2")
async def get_vulnerabilities2():
    packages = await detect_pip_packages()
    to_query = packages[:20]  # Limit for performance

    async with httpx.AsyncClient() as client:
        tasks = [query_osv_for_package(client, pkg) for pkg in to_query]
        python_results = await asyncio.gather(*tasks)

    python_vulns = [item for sublist in python_results for item in sublist]

    # System / Windows vulnerabilities (keyword "Windows" scans system CVEs)
    system_vulns = query_cve_nvd("Windows")

    # Merge both Python and system vulnerabilities
    vulns = python_vulns + system_vulns

    return JSONResponse(content={
        "vulns": vulns,
        "scanned_packages_count": len(packages)
    })



 

@router.get("/api/cpu_threads2")
def get_cpu_threads():
    cpu_info = []
    for i, times in enumerate(psutil.cpu_times(percpu=True)):
        cpu_info.append({
            "core": i,
            "user": times.user,
            "system": times.system,
            "idle": times.idle
        })
    return {"cores": cpu_info}



# Serve index.html
@router.get("/")
def read_index():
    return FileResponse(os.path.join("static", "index.html"))

# Serve vulnerability.html
@router.get("/vulnerability")
def read_vulnerability():
    return FileResponse(os.path.join("static", "vulnerability.html"))
